#!/bin/bash

INSTALL_DIR="$HOME/GarudRecon"

if [ -d "$INSTALL_DIR/.git" ]; then
    echo "[*] Updating GarudRecon..."
    cd "$INSTALL_DIR" || exit 1
    git reset --hard >/dev/null 2>&1   # clean local changes
    git pull --rebase --autostash >/dev/null 2>&1
else
    echo "[*] Cloning GarudRecon..."
    git clone --depth 1 https://github.com/rix4uni/GarudRecon.git "$INSTALL_DIR" &>/dev/null
    cd "$INSTALL_DIR" || exit 1
fi

# create garudrecon directory if not exit
mkdir -p "$HOME/.garudrecon"

# delete all files/directory in $HOME/.garudrecon except scans directory
find $HOME/.garudrecon -mindepth 1 -maxdepth 1 ! -name scans ! -name cronjobscan -exec rm -rf {} +

# send important files
mv cmd/ configuration/ modules/ $HOME/.garudrecon

# make it garudrecon globally
mv garudrecon /usr/bin/

# make it excutble
chmod +x $HOME/.garudrecon/cmd/* /usr/bin/garudrecon

# Get total RAM in GB
# Try dmidecode first
TOTAL_RAM_GB=$(dmidecode -t memory | grep -E "^\s*Size:" | grep -v "No Module Installed" | awk '{print $2}')

# Fallback to free -t if dmidecode fails or returns nothing
if [[ -z "$TOTAL_RAM_GB" ]]; then
    TOTAL_RAM_GB=$(free -t | awk '/^Mem:/ {printf "%.0f\n", $2/1e6}')
fi

# Select config based on RAM
if [ "$TOTAL_RAM_GB" -le 1 ]; then
    CONFIG="garudrecon_1g.cfg"
elif [ "$TOTAL_RAM_GB" -le 2 ]; then
    CONFIG="garudrecon_2g.cfg"
elif [ "$TOTAL_RAM_GB" -le 4 ]; then
    CONFIG="garudrecon_4g.cfg"
elif [ "$TOTAL_RAM_GB" -le 6 ]; then
    CONFIG="garudrecon_6g.cfg"
elif [ "$TOTAL_RAM_GB" -le 8 ]; then
    CONFIG="garudrecon_8g.cfg"
elif [ "$TOTAL_RAM_GB" -ge 16 ]; then
    CONFIG="garudrecon_max.cfg"
else
    CONFIG="garudrecon_max.cfg"  # fallback
fi

# set path to access globally according to system ram
sed -i -e "s|source \"configuration/garudrecon_max.cfg\"|source \"$HOME/.garudrecon/configuration/$CONFIG\"|" -e 's|bash "$(dirname "\$0")/cmd/\(.*\)"|bash "$HOME/.garudrecon/cmd/\1"|' /usr/bin/garudrecon
sed -i -e "s|CONFIG_PATH=\"configuration/garudrecon_max.cfg\"|CONFIG_PATH=\"$HOME/.garudrecon/configuration/$CONFIG\"|" -e 's|INSTALLEDLOGFILE="installed.log"|INSTALLEDLOGFILE="$HOME/.garudrecon/installed.log"|' $HOME/.garudrecon/cmd/install
sed -i -e "s|CONFIG_PATH=\"configuration/garudrecon_max.cfg\"|CONFIG_PATH=\"$HOME/.garudrecon/configuration/$CONFIG\"|" -e 's|BASEDIR="scans"|BASEDIR="$HOME/.garudrecon/scans"|' $HOME/.garudrecon/cmd/smallscope
sed -i -e "s|CONFIG_PATH=\"configuration/garudrecon_max.cfg\"|CONFIG_PATH=\"$HOME/.garudrecon/configuration/$CONFIG\"|" -e 's|BASEDIR="scans"|BASEDIR="$HOME/.garudrecon/scans"|' $HOME/.garudrecon/cmd/mediumscope
sed -i -e "s|CONFIG_PATH=\"configuration/garudrecon_max.cfg\"|CONFIG_PATH=\"$HOME/.garudrecon/configuration/$CONFIG\"|" -e 's|BASEDIR="scans"|BASEDIR="$HOME/.garudrecon/scans"|' $HOME/.garudrecon/cmd/largescope
sed -i -e "s|CONFIG_PATH=\"configuration/garudrecon_max.cfg\"|CONFIG_PATH=\"$HOME/.garudrecon/configuration/$CONFIG\"|" -e 's|BASEDIR="cronjobscan"|BASEDIR="$HOME/.garudrecon/cronjobscan"|' $HOME/.garudrecon/cmd/cronjobs

sed -i -e 's|mkdir -p wordlists|mkdir -p $HOME/.garudrecon/wordlists|' -e 's|mkdir -p takeovers|mkdir -p $HOME/.garudrecon/takeovers|' -e 's|mkdir -p templates|mkdir -p $HOME/.garudrecon/templates|' $HOME/.garudrecon/cmd/install
sed -i -e 's|cp -r ~/nuclei-templates/http/takeovers templates/takeovers|cp -r ~/nuclei-templates/http/takeovers $HOME/.garudrecon/templates/takeovers|' $HOME/.garudrecon/cmd/install
sed -i -e 's|templates/takeovers/\*\.yaml|$HOME/.garudrecon/templates/takeovers/*.yaml|' $HOME/.garudrecon/cmd/install
sed -i -e 's|WORDLIST_BASEDIR="wordlists"|WORDLIST_BASEDIR="$HOME/.garudrecon/wordlists"|' $HOME/.garudrecon/configuration/$CONFIG
sed -i -e 's|MODULES_DIR="modules"|MODULES_DIR="$HOME/.garudrecon/modules"|' $HOME/.garudrecon/cmd/workflow

# Default values
UPDATE_FLAG=""

# Detect if --update is passed
for arg in "$@"; do
    if [ "$arg" == "--update" ]; then
        UPDATE_FLAG="--update"
    fi
done

# Detect scope argument (first positional argument that's a number 1-8)
if [[ "$1" =~ ^[1-8]$ ]]; then
    choice="$1"
    case $choice in
        1) scope="SMALLSCOPE" ;;
        2) scope="MEDIUMSCOPE" ;;
        3) scope="LARGESCOPE" ;;
        4) scope="CIDRSCOPE" ;;
        5) scope="WORKFLOW" ;;
        6) scope="FLEET"
            TOTALVPS=$(grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | wc -l)
            echo "[*] FLEET mode selected. Deploying on $TOTALVPS VPS from credentials.txt..."

            FLEETDIR="$HOME/.garudrecon/fleet"
            OUTPUT="$HOME/.garudrecon/fleet/output"
            mkdir -p $FLEETDIR
            mkdir -p $OUTPUT

            # Send sshkey to Mini-Child-VPS
            KEY_PATH="$HOME/.ssh/id_ed25519.pub"
            # --- check & create key ---
            if [[ ! -f "$KEY_PATH" ]]; then
              echo "No public key at $KEY_PATH — generating a new ed25519 key..."
              ssh-keygen -t ed25519 -f "${HOME}/.ssh/id_ed25519" -N "" -q
              echo "Key generated: $KEY_PATH"
            fi

            export KEY_PATH
            parallel -a $HOME/credentials.txt --colsep ':' -j20 "
              sshpass -p {2} ssh-copy-id -i $KEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {1} &>/dev/null
            "

            # FLEET deployment logic here
            grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no {} "export PATH=$PATH:/usr/local/go/bin; curl -s https://gist.githubusercontent.com/rix4uni/c412ca956ea3bfa114bf4b615a9762bc/raw/91e9c8c93afbad3f16bdc41eb581f3e428dea9df/go.sh | bash"'
            grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no {} "export PATH=$PATH:/usr/local/go/bin; wget https://github.com/rix4uni/unew/releases/download/v0.0.6/unew-linux-amd64-0.0.6.tgz && tar -xvzf unew-linux-amd64-0.0.6.tgz && rm -rf unew-linux-amd64-0.0.6.tgz && mkdir -p ~/go/bin && mv unew ~/go/bin/unew"'
            grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no {} "tmux has-session -t fleet 2>/dev/null || tmux new-session -d -s fleet && tmux send-keys -t fleet \"bash <(curl -s https://raw.githubusercontent.com/rix4uni/GarudRecon/main/configure) 5\" C-m"'

            DEST="$FLEETDIR/${OUTPUT}"
            echo "[*] Waiting for results from $TOTALVPS VPS..."

            while true; do
                DONE=$(find "$FLEETDIR" -maxdepth 1 -type f -name "${OUTPUT}_*" | wc -l)

                # Calculate percentage
                PERCENT=$(( 100 * DONE / TOTALVPS ))

                # Build simple progress bar (50 chars wide)
                BAR_WIDTH=50
                FILLED=$(( PERCENT * BAR_WIDTH / 100 ))
                EMPTY=$(( BAR_WIDTH - FILLED ))
                BAR=$(printf "%${FILLED}s" | tr ' ' '#')
                SPACE=$(printf "%${EMPTY}s")

                echo -ne "\rProgress: [$BAR$SPACE] $DONE / $TOTALVPS VPS ($PERCENT%)"

                if [[ $DONE -ge $TOTALVPS ]]; then
                    echo "[*] FLEET deployment initiated."
                    break
                fi

                sleep 5
            done

            exit 0
            ;;
        7) scope="CRONJOBS" ;;
        8) scope="ALL" ;;
        *) scope="ALL" ;;  # fallback to ALL if invalid argument
    esac
else
    # Interactive mode
    echo "Choose installation scope:"
    echo "1) SMALLSCOPE"
    echo "2) MEDIUMSCOPE"
    echo "3) LARGESCOPE"
    echo "4) CIDRSCOPE"
    echo "5) WORKFLOW"
    echo "6) FLEET"
    echo "7) CRONJOBS"
    echo "8) ALL (default)"
    read -p "Enter your choice [1-8, press Enter for ALL]: " choice

    case $choice in
        1) scope="SMALLSCOPE" ;;
        2) scope="MEDIUMSCOPE" ;;
        3) scope="LARGESCOPE" ;;
        4) scope="CIDRSCOPE" ;;
        5) scope="WORKFLOW" ;;
        6) scope="FLEET"
            TOTALVPS=$(grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | wc -l)
            echo "[*] FLEET mode selected. Deploying on $TOTALVPS VPS from credentials.txt..."

            FLEETDIR="$HOME/.garudrecon/fleet"
            OUTPUT="$HOME/.garudrecon/fleet/output"
            mkdir -p $FLEETDIR
            mkdir -p $OUTPUT

            # Send sshkey to Mini-Child-VPS
            KEY_PATH="$HOME/.ssh/id_ed25519.pub"
            # --- check & create key ---
            if [[ ! -f "$KEY_PATH" ]]; then
              echo "No public key at $KEY_PATH — generating a new ed25519 key..."
              ssh-keygen -t ed25519 -f "${HOME}/.ssh/id_ed25519" -N "" -q
              echo "Key generated: $KEY_PATH"
            fi

            export KEY_PATH
            parallel -a $HOME/credentials.txt --colsep ':' -j20 "
              sshpass -p {2} ssh-copy-id -i $KEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {1} &>/dev/null
            "

            # FLEET deployment logic here
            grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no {} "export PATH=$PATH:/usr/local/go/bin; curl -s https://gist.githubusercontent.com/rix4uni/c412ca956ea3bfa114bf4b615a9762bc/raw/91e9c8c93afbad3f16bdc41eb581f3e428dea9df/go.sh | bash"'
            grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no {} "export PATH=$PATH:/usr/local/go/bin; wget https://github.com/rix4uni/unew/releases/download/v0.0.6/unew-linux-amd64-0.0.6.tgz && tar -xvzf unew-linux-amd64-0.0.6.tgz && rm -rf unew-linux-amd64-0.0.6.tgz && mkdir -p ~/go/bin && mv unew ~/go/bin/unew"'
            grep -vE '^\s*$|^\s*#' $HOME/credentials.txt | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no {} "tmux has-session -t fleet 2>/dev/null || tmux new-session -d -s fleet && tmux send-keys -t fleet \"bash <(curl -s https://raw.githubusercontent.com/rix4uni/GarudRecon/main/configure) 5\" C-m"'

            DEST="$FLEETDIR/${OUTPUT}"
            echo "[*] Waiting for results from $TOTALVPS VPS..."

            while true; do
                DONE=$(find "$FLEETDIR" -maxdepth 1 -type f -name "${OUTPUT}_*" | wc -l)

                # Calculate percentage
                PERCENT=$(( 100 * DONE / TOTALVPS ))

                # Build simple progress bar (50 chars wide)
                BAR_WIDTH=50
                FILLED=$(( PERCENT * BAR_WIDTH / 100 ))
                EMPTY=$(( BAR_WIDTH - FILLED ))
                BAR=$(printf "%${FILLED}s" | tr ' ' '#')
                SPACE=$(printf "%${EMPTY}s")

                echo -ne "\rProgress: [$BAR$SPACE] $DONE / $TOTALVPS VPS ($PERCENT%)"

                if [[ $DONE -ge $TOTALVPS ]]; then
                    echo "[*] FLEET deployment initiated."
                    break
                fi

                sleep 5
            done

            exit 0
            ;;
        7) scope="CRONJOBS" ;;
        8|"") scope="ALL" ;;   # empty input defaults to ALL
        *) echo "Invalid choice, defaulting to ALL"; scope="ALL" ;;
    esac
fi

echo "Selected scope: $scope"
echo "Update flag: $UPDATE_FLAG"

# Run the command
garudrecon install -f "$scope" $UPDATE_FLAG

# send config files
cp -r .config/* $HOME/.config


# Define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo -e "\n${BOLD}${CYAN}==> API Keys Configuration${NC}"
echo -e "${YELLOW}Add your API keys to these files:${NC}"
find .config -type f | while read -r file; do
    echo -e "${GREEN}~/${file}${NC}"
done

echo -e "\n${BOLD}${CYAN}==> Restore from Backup (GitHub)${NC}"
echo -e "${YELLOW}If you have a backup in a public repo:${NC}"
echo -e "  ${BLUE}git clone https://github.com/yourusername/private-config.git --depth 1${NC}"
echo -e "  ${BLUE}cp -r private-config/* /root/.config && rm -rf private-config${NC}"

echo -e "\n${YELLOW}If your backup is in a ${RED}private repo${YELLOW}:${NC}"
echo -e "  ${BLUE}git clone https://<TOKEN>@github.com/yourusername/private-config.git --depth 1${NC}"
echo -e "  ${BLUE}cp -r private-config/* /root/.config && rm -rf private-config${NC}"

echo -e "\n${BOLD}${CYAN}==> System Info${NC}"
echo -e "${YELLOW}Detected System RAM:${NC} ${GREEN}${TOTAL_RAM_GB} GB${NC}"
echo -e "${YELLOW}Recommended configuration file:${NC} ${GREEN}$CONFIG${NC}"
echo -e "${YELLOW}Configuration applied according to your System RAM:${NC} ${GREEN}$CONFIG${NC}\n"

cd ..
rm -rf GarudRecon
