#!/bin/bash

INSTALL_DIR="$HOME/GarudRecon"

if [ -d "$INSTALL_DIR/.git" ]; then
    echo "[*] Updating GarudRecon..."
    cd "$INSTALL_DIR" || exit 1
    git reset --hard >/dev/null 2>&1   # clean local changes
    git pull --rebase --autostash >/dev/null 2>&1
else
    echo "[*] Cloning GarudRecon..."
    git clone --depth 1 https://github.com/rix4uni/GarudRecon.git "$INSTALL_DIR" &>/dev/null
    cd "$INSTALL_DIR" || exit 1
fi

# create garudrecon directory if not exit
mkdir -p "$HOME/.garudrecon"

# delete all files/directory in $HOME/.garudrecon except scans directory
find $HOME/.garudrecon -mindepth 1 -maxdepth 1 ! -name scans ! -name cronjobscan -exec rm -rf {} +

# send important files
mv cmd/ configuration/ modules/ $HOME/.garudrecon

# make it garudrecon globally
mv garudrecon /usr/bin/

# make it excutble
chmod +x $HOME/.garudrecon/cmd/* /usr/bin/garudrecon

# set path to access globally
sed -i -e 's|source "configuration/garudrecon_max.cfg"|source "$HOME/.garudrecon/configuration/garudrecon_max.cfg"|' -e 's|bash "$(dirname "\$0")/cmd/\(.*\)"|bash "$HOME/.garudrecon/cmd/\1"|' /usr/bin/garudrecon
sed -i -e 's|CONFIG_PATH="configuration/garudrecon_max.cfg"|CONFIG_PATH="$HOME/.garudrecon/configuration/garudrecon_max.cfg"|' -e 's|INSTALLEDLOGFILE="installed.log"|INSTALLEDLOGFILE="$HOME/.garudrecon/installed.log"|' $HOME/.garudrecon/cmd/install
sed -i -e 's|CONFIG_PATH="configuration/garudrecon_max.cfg"|CONFIG_PATH="$HOME/.garudrecon/configuration/garudrecon_max.cfg"|' -e 's|BASEDIR="scans"|BASEDIR="$HOME/.garudrecon/scans"|' $HOME/.garudrecon/cmd/smallscope
sed -i -e 's|CONFIG_PATH="configuration/garudrecon_max.cfg"|CONFIG_PATH="$HOME/.garudrecon/configuration/garudrecon_max.cfg"|' -e 's|BASEDIR="scans"|BASEDIR="$HOME/.garudrecon/scans"|' $HOME/.garudrecon/cmd/mediumscope
sed -i -e 's|CONFIG_PATH="configuration/garudrecon_max.cfg"|CONFIG_PATH="$HOME/.garudrecon/configuration/garudrecon_max.cfg"|' -e 's|BASEDIR="scans"|BASEDIR="$HOME/.garudrecon/scans"|' $HOME/.garudrecon/cmd/largescope
sed -i -e 's|CONFIG_PATH="configuration/garudrecon_max.cfg"|CONFIG_PATH="$HOME/.garudrecon/configuration/garudrecon_max.cfg"|' -e 's|BASEDIR="cronjobscan"|BASEDIR="$HOME/.garudrecon/cronjobscan"|' $HOME/.garudrecon/cmd/cronjobs

sed -i -e 's|mkdir -p wordlists|mkdir -p $HOME/.garudrecon/wordlists|' -e 's|mkdir -p takeovers|mkdir -p $HOME/.garudrecon/takeovers|' -e 's|mkdir -p templates|mkdir -p $HOME/.garudrecon/templates|' $HOME/.garudrecon/cmd/install
sed -i -e 's|cp -r ~/nuclei-templates/http/takeovers templates/takeovers|cp -r ~/nuclei-templates/http/takeovers $HOME/.garudrecon/templates/takeovers|' $HOME/.garudrecon/cmd/install
sed -i -e 's|templates/takeovers/\*\.yaml|$HOME/.garudrecon/templates/takeovers/*.yaml|' $HOME/.garudrecon/cmd/install
sed -i -e 's|WORDLIST_BASEDIR="wordlists"|WORDLIST_BASEDIR="$HOME/.garudrecon/wordlists"|' $HOME/.garudrecon/configuration/garudrecon_max.cfg
sed -i -e 's|MODULES_DIR="modules"|MODULES_DIR="$HOME/.garudrecon/modules"|' $HOME/.garudrecon/cmd/workflow


# install tools
echo "Choose installation scope:"
echo "1) SMALLSCOPE"
echo "2) MEDIUMSCOPE"
echo "3) LARGESCOPE"
echo "4) WORKFLOW"
echo "5) CRONJOBS"
echo "6) ALL (default)"
read -p "Enter your choice [1-6, press Enter for ALL]: " choice

case $choice in
    1) scope="SMALLSCOPE" ;;
    2) scope="MEDIUMSCOPE" ;;
    3) scope="LARGESCOPE" ;;
    4) scope="WORKFLOW" ;;
    5) scope="CRONJOBS" ;;
    6|"") scope="ALL" ;;   # empty input defaults to ALL
    *) echo "Invalid choice, defaulting to ALL"; scope="ALL" ;;
esac

garudrecon install -f "$scope"

# send config files
cp -r .config/* $HOME/.config


# Define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo -e "${BOLD}${CYAN}==> API Keys Configuration${NC}"
echo -e "${YELLOW}Add your API keys to these files:${NC}"
find .config -type f | sed "s|^|${GREEN}~/|; s|\$|${NC}|"

echo -e "\n${BOLD}${CYAN}==> Restore from Backup (GitHub)${NC}"
echo -e "${YELLOW}If you have a backup in a public repo:${NC}"
echo -e "  ${BLUE}git clone https://github.com/yourusername/private-config.git --depth 1${NC}"
echo -e "  ${BLUE}cp -r private-config/* /root/.config && rm -rf private-config${NC}"

echo -e "\n${YELLOW}If your backup is in a ${RED}private repo${YELLOW}:${NC}"
echo -e "  ${BLUE}git clone https://<TOKEN>@github.com/yourusername/private-config.git --depth 1${NC}"
echo -e "  ${BLUE}cp -r private-config/* /root/.config && rm -rf private-config${NC}"


# Get total RAM in GB (rounded down)
TOTAL_RAM_GB=$(free -g | awk '/^Mem:/{print $2}')

echo -e "\n${BOLD}${CYAN}==> System Info${NC}"
echo -e "${YELLOW}Detected System RAM:${NC} ${GREEN}${TOTAL_RAM_GB} GB${NC}"

if [ "$TOTAL_RAM_GB" -le 1 ]; then
    CONFIG="garudrecon_1g.cfg"
elif [ "$TOTAL_RAM_GB" -le 2 ]; then
    CONFIG="garudrecon_2g.cfg"
elif [ "$TOTAL_RAM_GB" -le 4 ]; then
    CONFIG="garudrecon_4g.cfg"
elif [ "$TOTAL_RAM_GB" -le 6 ]; then
    CONFIG="garudrecon_6g.cfg"
elif [ "$TOTAL_RAM_GB" -le 8 ]; then
    CONFIG="garudrecon_8g.cfg"
elif [ "$TOTAL_RAM_GB" -ge 16 ]; then
    CONFIG="garudrecon_max.cfg"
else
    CONFIG="garudrecon_max.cfg"  # fallback
fi

echo -e "${YELLOW}Recommended config file:${NC} ${GREEN}$CONFIG${NC}\n"

cd ..
rm -rf GarudRecon
