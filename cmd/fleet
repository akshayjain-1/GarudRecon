#!/bin/bash


# Help function
function show_help() {
  cat <<EOF
Distribute work across many VPS instances — split input automatically and run modules in parallel on 100+ hosts.
Use one command to shard data, push jobs to remote nodes, run the chosen module, and collect consolidated results. Perfect for massively-parallel scans.

Usage:
  garudrecon fleet [flags]

Flags:
  -i, --input       Pass the input
  -o, --output      Location where you want to save output
  -m, --module      module name you want to run
  -v, --verbose     enable verbose mode
  -h, --help        help for modules

Example:
  garudrecon fleet -m <module> -i <wildcards> -o <file> [--verbose]
  garudrecon fleet -m httpx -i subs.txt -o subs.httpx --verbose
EOF
}


# --- normal module execution ---
# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -i|--input)
      INPUT="$2"
      shift 2
      ;;
    -o|--output)
      OUTPUT="$2"
      shift 2
      ;;
    -m|--module)
      MODULE="$2"
      shift 2
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done


# Creating directory
FLEETDIR="$HOME/.garudrecon/fleet"
FLEET_MODULEDIR="$HOME/.garudrecon/fleet/$MODULE"
SPLITDIR="$HOME/.garudrecon/fleet/$MODULE/split-output"

mkdir -p $FLEETDIR
mkdir -p $FLEET_MODULEDIR
mkdir -p $SPLITDIR


# Split files logic
FILE=${INPUT}
TOTALVPS=$(cat $HOME/worker.credentials | wc -l)
SPLIT=$(echo "$INPUT" | sed 's/\.[^.]*$//')

LINES=$(wc -l < "$FILE")
PER_VPS=$(( (LINES + $TOTALVPS - 1) / $TOTALVPS ))
echo "TOTAL: $LINES, Lines per VPS: $PER_VPS"

# Split the file
split --numeric-suffixes=1 -a 3 -l $PER_VPS "$FILE" $SPLITDIR/${SPLIT}.

# Renames files like: $SPLITDIR/${SPLIT}.001 → $SPLITDIR/${SPLIT}.1
for f in $SPLITDIR/${SPLIT}.[0-9][0-9][0-9]; do
    n=$(echo "$f" | sed -E 's/.*\.0*([0-9]+)/\1/')
    mv "$f" "$SPLITDIR/${SPLIT}.$n" &>/dev/null
done

# Delete empty files
find $SPLITDIR -type f -empty -delete


# Send sshkey to Mini-Child-VPS
KEY_PATH="$HOME/.ssh/id_ed25519.pub"
# --- check & create key ---
if [[ ! -f "$KEY_PATH" ]]; then
  echo "No public key at $KEY_PATH — generating a new ed25519 key..."
  ssh-keygen -t ed25519 -f "${HOME}/.ssh/id_ed25519" -N "" -q
  echo "Key generated: $KEY_PATH"
fi

export KEY_PATH
parallel -a $HOME/worker.credentials --colsep ':' -j20 "
  sshpass -p {2} ssh-copy-id -i $KEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {1} &>/dev/null

  ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 {1} "mkdir -p $FLEETDIR" &>/dev/null

  echo "Sending file ${SPLIT}.{#} to {1}..."
  scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $SPLITDIR/${SPLIT}.{#} {1}:$FLEETDIR/${INPUT}

  echo "Sending module file $HOME/.garudrecon/modules/${MODULE}.json to {1}..."
  scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $HOME/.garudrecon/modules/${MODULE}.json {1}:$HOME/.garudrecon/modules/${MODULE}.json
"

# Create a tmux session
grep -vE '^\s*$|^\s*#' $HOME/worker.credentials | cut -d: -f1 | parallel -j50 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {} "tmux new-session -d -s fleet"'

# Run command in tmux session and send file to "main VPS"
if $VERBOSE; then
  grep -vE '^\s*$|^\s*#' $HOME/worker.credentials | cut -d: -f1 | parallel -j50 "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {} \"tmux send-keys -t fleet \\\"garudrecon workflow ${MODULE} -i $FLEETDIR/${INPUT} -o $FLEETDIR/${OUTPUT} --verbose && scp -q -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -i ~/.ssh/id_rsa_vps $FLEETDIR/${OUTPUT} \\\$(shuf -n 1 $HOME/master.credentials | cut -d: -f1):$FLEET_MODULEDIR/${OUTPUT}_{} &>/dev/null && rm -rf fleet\\\" C-m\""
else
  grep -vE '^\s*$|^\s*#' $HOME/worker.credentials | cut -d: -f1 | parallel -j50 "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {} \"tmux send-keys -t fleet \\\"garudrecon workflow ${MODULE} -i $FLEETDIR/${INPUT} -o $FLEETDIR/${OUTPUT} && scp -q -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -i ~/.ssh/id_rsa_vps $FLEETDIR/${OUTPUT} \\\$(shuf -n 1 $HOME/master.credentials | cut -d: -f1):$FLEET_MODULEDIR/${OUTPUT}_{} &>/dev/null && rm -rf fleet\\\" C-m\""
fi

DEST="$FLEETDIR/${OUTPUT}"
TOTALVPS=$(grep -vE '^\s*$|^\s*#' $HOME/worker.credentials | cut -d: -f1 | wc -l)

echo "[*] Waiting for results from $TOTALVPS VPS..."

while true; do
    DONE=$(find "$FLEETDIR" -maxdepth 1 -type f -name "${OUTPUT}_*" | wc -l)

    # Calculate percentage
    PERCENT=$(( 100 * DONE / TOTALVPS ))

    # Build simple progress bar (50 chars wide)
    BAR_WIDTH=50
    FILLED=$(( PERCENT * BAR_WIDTH / 100 ))
    EMPTY=$(( BAR_WIDTH - FILLED ))
    BAR=$(printf "%${FILLED}s" | tr ' ' '#')
    SPACE=$(printf "%${EMPTY}s")

    echo -ne "\rProgress: [$BAR$SPACE] $DONE / $TOTALVPS VPS ($PERCENT%)"

    if [[ $DONE -ge $TOTALVPS ]]; then
        echo -e "\n[*] All VPS finished, merging..."
        # deduplicated and merge in 1 file
        cat "$FLEETDIR"/${OUTPUT}_* | unew -q "$DEST"
        # rm -f "$FLEETDIR"/${OUTPUT}_*
        rm -rf $SPLITDIR
        echo "[+] Deduplicated results saved to $DEST"
        break
    fi

    sleep 5
done
